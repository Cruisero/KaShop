// Prisma Schema for Kashop
// 虚拟物品发卡平台数据模型

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// 用户表
model User {
  id                String    @id @default(uuid())
  email             String    @unique
  password          String
  username          String?
  role              Role      @default(USER)
  avatar            String?
  emailVerified     Boolean   @default(false) @map("email_verified")
  verificationToken String?   @map("verification_token")
  resetToken        String?   @map("reset_token")
  resetTokenExpiry  DateTime? @map("reset_token_expiry")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  
  orders    Order[]
  
  @@map("users")
}

enum Role {
  USER
  ADMIN
}

// 分类表
model Category {
  id          String    @id @default(uuid())
  name        String
  description String?
  icon        String?
  sortOrder   Int       @default(0) @map("sort_order")
  status      Status    @default(ACTIVE)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  products    Product[]
  
  @@map("categories")
}

// 商品表
model Product {
  id            String    @id @default(uuid())
  categoryId    String?   @map("category_id")
  name          String
  description   String?   @db.Text
  fullDescription String? @db.Text @map("full_description")
  price         Decimal   @db.Decimal(10, 2)
  originalPrice Decimal?  @db.Decimal(10, 2) @map("original_price")
  stock         Int       @default(0)
  soldCount     Int       @default(0) @map("sold_count")
  image         String?
  images        Json?
  tags          Json?
  status        Status    @default(ACTIVE)
  sortOrder     Int       @default(0) @map("sort_order")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  
  category      Category? @relation(fields: [categoryId], references: [id])
  cards         Card[]
  orders        Order[]
  variants      ProductVariant[]
  
  @@map("products")
}

// 商品规格表
model ProductVariant {
  id            String    @id @default(uuid())
  productId     String    @map("product_id")
  type          String?   // 规格类型，如"共享"、"独享"，用于分组
  name          String    // 规格名称，如"月卡"、"季卡"、"年卡"
  price         Decimal   @db.Decimal(10, 2)
  originalPrice Decimal?  @db.Decimal(10, 2) @map("original_price")
  stock         Int       @default(0)
  sortOrder     Int       @default(0) @map("sort_order")
  status        Status    @default(ACTIVE)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  
  product       Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  cards         Card[]
  
  @@map("product_variants")
}

enum Status {
  ACTIVE
  INACTIVE
}

// 卡密表
model Card {
  id        String     @id @default(uuid())
  productId String     @map("product_id")
  variantId String?    @map("variant_id")
  content   String     @db.Text
  status    CardStatus @default(AVAILABLE)
  orderId   String?    @map("order_id")
  soldAt    DateTime?  @map("sold_at")
  createdAt DateTime   @default(now()) @map("created_at")
  
  product   Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant   ProductVariant? @relation(fields: [variantId], references: [id])
  order     Order?     @relation(fields: [orderId], references: [id])
  
  @@map("cards")
}

enum CardStatus {
  AVAILABLE
  SOLD
  EXPIRED
}

// 订单表
model Order {
  id            String      @id @default(uuid())
  orderNo       String      @unique @map("order_no")
  userId        String?     @map("user_id")
  email         String
  productId     String      @map("product_id")
  productName   String      @map("product_name")
  variantId     String?     @map("variant_id")
  variantName   String?     @map("variant_name")
  quantity      Int         @default(1)
  unitPrice     Decimal     @db.Decimal(10, 2) @map("unit_price")
  totalAmount   Decimal     @db.Decimal(10, 2) @map("total_amount")
  usdtAmount    Decimal?    @db.Decimal(10, 2) @map("usdt_amount")
  status        OrderStatus @default(PENDING)
  paymentMethod String?     @map("payment_method")
  paymentNo     String?     @map("payment_no")
  paidAt        DateTime?   @map("paid_at")
  completedAt   DateTime?   @map("completed_at")
  cancelledAt   DateTime?   @map("cancelled_at")
  ipAddress     String?     @map("ip_address")
  userAgent     String?     @db.Text @map("user_agent")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  
  user          User?       @relation(fields: [userId], references: [id])
  product       Product     @relation(fields: [productId], references: [id])
  cards         Card[]
  payment       Payment?
  
  @@map("orders")
}

enum OrderStatus {
  PENDING
  PAID
  COMPLETED
  CANCELLED
  REFUNDED
}

// 支付记录表
model Payment {
  id            String        @id @default(uuid())
  orderId       String        @unique @map("order_id")
  paymentMethod String        @map("payment_method")
  amount        Decimal       @db.Decimal(10, 2)
  tradeNo       String?       @map("trade_no")
  status        PaymentStatus @default(PENDING)
  rawData       Json?         @map("raw_data")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  
  order         Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  @@map("payments")
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

// 系统设置表
model Setting {
  id          String   @id @default(uuid())
  key         String   @unique
  value       String?  @db.Text
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  @@map("settings")
}
